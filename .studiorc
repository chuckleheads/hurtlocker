#!/bin/bash

RED='\033[0;31m'
NO_COLOR='\033[0m'

stop-on-failure() {
  (set -e; "$@");
  rv=$?
  if [ $rv -ne 0 ]; then
    echo -e "${RED}ERROR: $* aborted due to error${NO_COLOR}"
    return 1
  fi
}

configure() {
  /src/support/dev/config.sh
}

install-packages() {
  hab pkg install \
  core/cacerts \
  core/net-tools \
  core/procps-ng \
  core/curl \
  -b -c stable
}

no_install_deps() {
  local file="/src/cleanup"
  if [ ! -f "$file" ]; then
    touch "$file"
  else
    echo "1"
  fi
}

# Cleanup any development touch files we laid down when checking to see if we could run NO_INSTALL_DEPS
_cleanup() {
  if [ -f "/src/cleanup" ]; then
    rm "/src/cleanup"
  fi
}

start-hurtlocker() {
  start-rabbitmq
  start-datastore
  start-originsrv
  start-gateway
  start-agent
  start-sessionsrv
}

start-rabbitmq() {
  hab svc load core/rabbitmq
}

stop-rabbitmq() {
  hab svc unload core/rabbitmq
}

start-datastore() {
  hab svc load chuckleheads/datastore
}

stop-datastore() {
  hab svc unload chuckleheads/datastore
}

start-originsrv() {
  hab svc load chuckleheads/originsrv --bind datastore:datastore.default
}

stop-originsrv() {
  hab svc unload chuckleheads/originsrv
}

start-sessionsrv() {
  hab svc load chuckleheads/sessionsrv --bind datastore:datastore.default
}

stop-sessionsrv() {
  hab svc unload chuckleheads/sessionsrv
}

start-gateway() {
    hab svc load chuckleheads/gateway
}

stop-gateway() {
    hab svc unload chuckleheads/gateway
}

start-agent() {
    hab svc load chuckleheads/agent --bind rabbitmq:rabbitmq.default
}

stop-agent() {
    hab svc unload chuckleheads/agent
}

_build-component() {
  stop-$1
  NO_INSTALL_DEPS=$(no_install_deps "$1") \
    build "/src/components/$1/habitat-dev"

  echo "$1 build succeeded"
  start-$1
}
build-component() { stop-on-failure _build-component "$1"; }

alias bh=build-hurtlocker
_build-hurtlocker() {
  if [[ $(hab sup status) == "No services loaded." ]]; then
    start-hurtlocker
  fi

  if [[ "$#" -eq 0 ]]; then
    build-component originsrv
    build-component gateway
    build-component agent
    build-component sessionsrv
    return $?
  fi
}
build-hurtlocker() { stop-on-failure _build-hurtlocker; }

trap _cleanup EXIT

alias help=dev_docs
dev_docs() {
  cat <<DOCS
Welcome to the development environment for hurtlocker.
The following commands are available:

* start-hurtlocker - Start up all the services
* start-datastore - Start just the datastore
* stop-datastore - Stop just the datastore
* start-originsrv - Start just originsrv
* stop-originsrv - Stop just originsrv
* start-gateway - Start just the gateway
* stop-gateway - Stop just the gateway
* build-originsrv - Recompile originsrv. This will also automatically restart the service.
* build-gateway - Recompile the gateway. This will also automatically restart the service.
* dev_docs (alias: help) - What you're reading now

DOCS
}

install-packages
configure
